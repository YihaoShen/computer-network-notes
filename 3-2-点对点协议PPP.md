## 点对点协议PPP

在通信链路较差的年代，在数据链路层使用可靠传输协议曾经是一种好方法，比较简单的**点对点PPP协议**则是目前使用最广泛的数据链路层协议。

### PPP协议的特点

互联网用户通过都要连接到某个ISP才能接入到互联网。PPP协议就是用户计算机和ISP进行通信时所使用的数据链路层协议。如图(图3-9)

![image](https://img2020.cnblogs.com/blog/2361214/202111/2361214-20211105110724225-720325536.png)

ppp协议是IETF在1992年制定的，现在的PPP协议在1994年就已经成为了互联网的正式标准[RFC 1661]。

#### PPP协议应该满足的需求

IEFE认为，在设计PPP协议的时候就应该从以下方面考虑：

1. 简单
数据链路层没有必要提供比IP协议更多的功能，因此，对数据链路层的帧，**不需要纠错，不需要排序号，也不需要流量控制。**

2. 封装成帧
PPP协议必须规定**特殊的字符作为帧定界符(即标志一个帧的开始字符和结束字符)**，以便接收端从收到的比特流中能够准确地找出帧的开始和结束位置。

3. 透明性
PPP协议必须保持数据传输的透明性，也就是说，如果数据当中出现了与帧定界符一样的比特组合的时候，就要采取有效的措施来解决这个问题。

4. 多种网络协议
PPP协议能够在**同一条物理链路上同时支持多种网路层协议**的运行，当点对点链路所连接的是局域网或者路由器的时候，PPP协议必须同时支持在链路所连接的局域网或者路由器上运行的各种网络协议。

5. 多种类型链路
除了要支持多种网络层协议，还要支持在多种类型上的数据链路上运行。

6. 差错检测
PPP协议必须能够对接收端接收到的数据帧进行帧检测，如果出现错误，**立即丢弃掉这个错误的帧**，**如果接收到的错误帧不丢弃，就会在网络上继续向前到网络层进行转发，这回白白丢弃掉很多的网络资源。**

7. 检测连接状态
PPP协议必须要有一种能够自动检测链路是否在正常工作的机制。

8. 最大传输单元
PPP协议必须对每一种类型的点对点链路设置**最大传输单元MTU的标准默认值(1500字节)**，这样做是为了促进各种实现之间的可操作性。**如果高层协议发送的分组超过了MTU值，PPP就会丢弃掉这样的帧，并返回差错，报告给上层**，需要注意的是，MTU是数据链路层的帧可以载荷的**数据部分的最大长度**，而不是帧的总长度。

9.  网络层地址协商
PPP协议必须提供一种使通信的两个网络层(例如：两个IP层)的实体能够通过协商知道或者能够配置彼此的网络地址。协商的算法应该尽可能的简单，并且能够在所有的请款下该得到结果。**这对拨号连接的链路特别的重要，因为如果仅仅在链路层建立了连接而不知道对方的网络层地址，则不能够保证早网络层传输分组**。

10. 数据压缩协商
PPP协议必须能够提供一种方法协商使用数据压缩算法。但是PPP协议并不要求将数据压缩到标准化。

在TCP/IP协议族中，可靠传输由传输层的TCP协议控制，因此数据链里层的PPP协议不需要进行纠错，不需要设置序列号，也不需要进行流量控制。**PPP协议不支持多点线路(即一个主站和链路上的多个从站i纪念性通信，它只支持点对点的链路通信。此外，PPP协议支支持全双工链路)**。

#### PPP协议的组成

PPP协议有以下三部分

1. 一个将完整的IP数据报封装到串行链路上。

2. 一个用来建立，配置和测试数据链路层的**链路控制协议LCP(Link Control Protocol)**。通信的双方可以协商一些选项。

3. 一套网络控制协议**NCP**，其中的每一个协议支持不同的网络层协议，如IP层，DECnet等。

### PPP协议的帧格式

#### 各字段的意义

如图
PPP帧的首部和尾部分别为四个字段和两个字段。

![image](https://img2020.cnblogs.com/blog/2361214/202111/2361214-20211105110821233-650723374.png)


1. 首部的第一个字段和尾部的第二个字段都是标志字段，规定为**0x7E(01111110)**,标志着一个帧的开始或者结束，**因此标志字段就是PPP帧的定界符**。连续两帧之间只需要用一个标志字段，如果出现连续两个标志字段，则表示是一个空的PPP帧，应当丢弃。 

2.首部当中的地址字段A规定为0xFF,控制字段C规定为0x03(00000011)。(这两个字段没有实际什么用途)

3. PPP首部的第四个字段是2字节的协议字段
   * 当协议字段为0x0021,代表的是IP数据报;
   * 当协议字段为0xC021,代表的是链路控制协议LCP数据;
   * 当协议字段为0x8021,代表的是网络层的控制数据;
  
4. 信息字段的长度是可变的，但不能超过1500字节。

5. 尾部的第一个字段(2字节)是使用CRC的帧检验序列FCS。

#### 字节填充

当信息字段出现了0x7E这样的比特流，就必须采取必要措施使得不会被接收端认为这是帧定界符号。

当PPP使用异步传输的时候(逐个字符发送)，把每一个0x7E字节转变为两个字节序列(0x7D和0x5E),若信息字段中出现了0x7D或者0x5E这样的转义字符，则把0x7D转变为2字节序列(0x7D和0x5D)；如果出现了控制字符，例如0x03(在控制字符串表示传输结束)，就变成2字节序列(0x7D,0x23)。由于在发送端进行了字节填充，因此在链路上传送的信息字节数就超过了原来的字节数。但接收端在收到字节后再进行与发送端字节填充相反的交换，就可以正确的恢复出原来的信息。
 
#### 0比特填充 

当PPP使用同步传输的时候(一连串的比特发送)，PPP协议采用的是0比特字节填充来实现透明传输。

![image](https://img2020.cnblogs.com/blog/2361214/202111/2361214-20211105110845447-365968320.png)

具体做法是(如上图)：在发送端，先扫描整个信息段(通常使用硬件扫描，也可以使用软件，不过比较慢)，只要发现有5个连续的1，就立即填入一个0，因此经过这种0比特填充后的数据，就可以保证再信息字段中不会出现帧界定符号(01111110)，接收端在接收到一个帧的时候，先找到一个标志字段F(7E)边界,接着再用硬件对其中的比特流进行扫描。每当发现连续的5个1的时候，就把这个连续的5个1后面的0删除掉，以还原成原来的信息比特流(如图3-11)，这样就保证了透明传输：在传输的数据比特流过程中可以传送任意组合的比特流，而不会引起帧边界的错误判断。


### PPP协议的工作状态

刚才我们讨论了PPP帧的格式和PPP帧是怎么组成的。但是PPP链路到底一开始是怎么被初始化的呢？当用户拨号进入ISP后，就建立的一条从用户个人电脑到ISP的ISP连接，这时，用户个人电脑向ISP发送一系列的链路控制协议LCP分组(封装成多个PPP帧)，以便建立LCP连接，这些分组及其响应选择了将要使用的一些PPP参数。接着还要进行网络层配置，网络控制协议NCP给新接入的用户个人电脑分配了一个临时的IP地址，这样，用户个人电脑就可以成为了互联网上一个有IP地址的主机了。

当用户通信完毕后，NCP就释放网络层连接，收回原来分配出去的IP地址，接着LCP释放数据链路层的连接，最后释放的是物理层的连接。

上述过程可用图3-12的状态图描述：

PPP链路的起始和终止状态永远是图中的**链路静止**状态，这时候用户电脑和ISP的路由器之间并不存在物理层的连接。

当用户电脑通过调制解调器呼叫路由器的时候(屏幕上的连接按钮)，路由器就能检测到调制解调器发出的载波信号，在双方建立了物理层连接之后，PPP就进入了**链路建立**状态，其目的是建立**LCP**连接。

这时候LCP开始协商一些配置项，即发送LCP的**配置请求帧**，这是个PPP帧，其协议字段为LCP的协议代码(0xC021)，而信息字段包含特定的配置请求。链路的另一端可以发送以下几种响应的一种：

1. 配置确认帧：所有选项都接受。

2. 配置否认帧：所有配置都理解但不能接受。

3. 配置拒绝帧：选项中有的无法识别或者不能接受，需要协商。

![image](https://img2020.cnblogs.com/blog/2361214/202111/2361214-20211105110936611-1095395434.png)

协商结束后就建立了LCP链路，接着就进入**鉴别**状态，在这一状态，只允许传送LCP协议的分组，鉴别协议的分组以及监控链路质量的分组，如果鉴别失败，则转到链路终止状态，若鉴别成功，则进入**网络层协议状态**。

在网络层协议状态中，PPP链路的两端的网络控制协议NCP根据网络层的不同协议互相交换网络层网络层特定的网络控制分组。这个步骤很重要的，因为现在的路由器能够同时支持网络层协议。总之，PPP协议的两端的网络层可以运行不同的网络层协议，但仍然可以使用同一个PPP协议进行通信。

当网络层配置完毕后，链路就进入可进行通信的**链路打开**状态，链路的两个PPP端点可以彼此发送分组。两个PPP端点还可以发送回送请求LCP分组和回送回答LCP分组，以检查链路的状态。

数据传输结束后，可以由链路的一端发送**终止请求LCP分组**请求终止链路连接，在收到对方发送过来的LCP分组后，转到**链路终止状态**，如果链路出现故障，也会从**链路打开**状态转到**链路终止**状态，当调制解调器的载波停止后，则返回到**链路静止**状态。
