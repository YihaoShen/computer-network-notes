## MAC层的硬件地址

在局域网中，**硬件地址**又称为**物理地址**或者**MAC地址**（因为这种地址用在MAC帧中）

IEEE 802标准为局域网规定了一种48位(6字节)的全球地址，固化在适配器的ROM中。

如果计算机中或者路由器有多个适配器，那么这样的主机或者路由器就有多个“地址”，更准确的说，这种48位“地址”应当是某个接口的标识符。

IEEE的注册管理结构RA是局域网全球地址的法定管理机构，它负责分配地址字段6个字节中的前三个字节。**世界上凡是要生产局域网适配器的厂家都必须向IEEE注册管理结构购买由这三个字节构成的号(地址块)**，这个号的正式名称为**组织唯一标识符OUI**，通常也叫公司标标识符。

以太网适配器还可以设置为一种特殊的工作方式，即**混杂模式**，工作在混杂模式的适配器只要“听到”有帧在以太网上就可以悄悄传输接收下来，而不管帧发送到哪里。

## MAC帧格式

常用的以太网MAC帧格式有两种，一种是DIX Ethernet V2标准(以太网V2标准)，另一种是IEEE的802.3标准。这里介绍使用最多的以太网V2的MAC帧格式(图3-22)。图中假定网络层使用的是IP协议。

![image](https://img2020.cnblogs.com/blog/2361214/202111/2361214-20211112123905839-1280177819.png)

以太网V2的MAC帧比较简单，由5个字段组成。前两个字段分别为6字节长的**目的地址**和**源地址**字段。第三个字段为2字节的**类型字段**，用来标识上一层(例如网络层)使用的是什么协议，以便把收到的MAC帧的数据上交给上一层的这个协议。例如，当协议字段为0x0800代表上层网络层使用的是IP数据报；若类型为0x8137表示的是上层是从Novell IPX发过来的。第四个字段是**数据字段**，其长度为46-1500字节之间(最小长度64字节减去首部和尾部以及类型的长度18)。第五个字段为4字节的**帧检验序列FCS(使用CRC校验)**。

MAC层怎么知道从从接收到的以太网帧取出多少字节交付给上一次层呢？这时候我们需要说一下曼彻斯特编码，曼彻斯特编码的重要一个特点是：在曼彻斯特编码的每一个码元的正中间一定有一次电压转换(由高到低或者由低到高)。当发送方把一个以太网帧发送完毕后，就不再发送其它码元了(既不发送0，也不发送1)。因此，发送方的网络适配器上的接口上的电压就不会发生变化了。这样，接收方就可以很容易找到以太网帧的结束位置。在这个位置上往前移4字节(FCS校验4字节)，就能确定数据字段的结束位置。

当数据字段的长度小于46字节时候，MAC子层就会在数据字段加入一个整数字段进行填充，以保证以太网的帧不小于64字节。

从图3-22还可以看出，在传输媒体上实际传送的要比MAC帧还多8个字节，这是因为当一个站在刚开始接收MAC帧时，由于适配器的时钟尚未与到达的比特流达成同步，因此MAC帧的最前面的若干位就无法接收，结果使得整个MAC帧成为无用的帧。为了接收端迅速的实现位同步，从MAC层向下物理层还要帧的前面插入8字节(由硬件生成)，它由两个字段构成。第一个字段时7字节的**前同步码(1和0交替码)**，它的作用是使接收端的适配器在接收MAC帧的时候能够迅速调整其时钟频率，使它和发送端的时钟同步，也就是**实现位同步**，第二个字段是**帧开始定界符*，定义为10101011*,它的前6位作用和前同步码一样，最后两个连续的1就是告诉接收端适配器：“MAC帧信息就要来了，请适配器注意接收”。

在以太网上传送数据时是以**帧**位单位传送的。以太网在传送帧时，各帧之间还必须有一定的间隙。因此，接收端只要找到帧开始定界符，其后面的连续到达的比特流就属于同一个MAC帧。可见以太网不需要使用帧结束定界符。

## 扩展的以太网

扩展的以太网再网络层看起来仍然是一个网络

### 在物理层扩展以太网

以太网上的主机之间的距离不能太远，否则主机发送的信号经过铜线传输就会衰减到CSMA/CD协议无法正常工作。

现在，扩展主机和集线器之间的距离的一种办法就是使用光纤和一堆光纤调制解调器。如图3-23：所示：

![image](https://img2020.cnblogs.com/blog/2361214/202111/2361214-20211112123946556-1176486453.png)

光纤调制解调器的作用是进行电信号与光信号的转换。由于光纤带来的时延很小，并且带宽很宽，因此使用这种方法可以很容易的使主机从几千公里以外的集线器相连。

### 在数据链路层扩展以太网

扩展以太网更常用的方法是在数据链路层上进行。最初人们使用的是**网桥**，网桥对接收到的帧根据其目的MCA地址进行**转发**和**过滤**。

在1990年出现了**以太网交换机**
以太网交换机实质上就是一个**多接口的网桥**，以太网交换机的每个接口都直接与一台计算机或者另一台以太网交换机相连。并且一般都是工作在**全双工方式**，以太网交换机还具有**并行性**，即能同时联通多对接口，使多对主机能同时通信(而网桥只能一次分析和转发一个帧)，相互通信的主机都是**独占传输媒体，无碰撞的传输数据**。 

以太网的接口还有存储器，能在输出端口繁忙时把到来的帧进行缓存。因此，如果以太网交换机上的两台主机，同时向另一台主机发送帧，那么当这台主机上的接口繁忙时，发送帧的这两台主机的接口会把收到的帧暂存一下，以后再发送出去。

以太网交换机是一种即插即用的设备，其内部的帧交换表(又称地址表)是通过**自学习**算法自动逐渐建立起来的。以太网交换机由于使用了专门的交换结构芯片，用硬件转发，其转发速率往往比要使用软件转发快得多。

#### 以太网交换机的自学习功能

使用一个简单的例子说明交换机是怎样进行学习的。
假定在图3-25中以太网有4个接口，各连接一台计算机，其MAC地址分别为A,B,C,D。一开始交换机里面的交换表使空的。(图3-25(a))

![image](https://img2020.cnblogs.com/blog/2361214/202111/2361214-20211112124010957-943725493.png)

A向B发送一帧，从端口1进入到交换机，交换机在接收到帧后，先查找交换表，没有查到应从哪个接口转发这个帧(在MAC地址这列中，找不到目的地址为B的主机)。接着，交换机把这个帧的源地址A和接口2写入到交换表中，并向除接口1以外的所有接口广播这个帧。

C,D丢弃掉这个帧，因为目的地址不对，只有B收下这个帧，这也称之为**过滤**。

从新写入交换表的项目(A,1)可以看出，以后不管从哪一个接口收到帧，只要其目的地址是A，就应当把收到的帧从接口1转发出去。这样做的依据是：**既然A发出的帧是从接口1进入到交换机的，那么从交换机的接口1转发出去的帧也应当可以到达A**。经过一段时间后，交换表中的项目就齐全了。

有时候交换机上的接口更换主机，或者主机更换了网络适配器，这就需要更改交换表中的项目。为此，在交换表中每个项目都设有一定的有效时间，过期的项目就会被自动删除，用这样的方法保证交换表中的数据都符合当前网络的实际情况。

以太网交换机的这种自学方法不需要人工进行配置，非常的方便。

但有时候为了增加网络的可靠性，在使用以太网交换机组件网络的时候，往往会增加一些冗余的链路。在这种情况下，自学习的过程就可能导致以太网帧在网络的某一个环路中无限制的兜圈子，白白消耗了网络资源，如图3-26：

![image](https://img2020.cnblogs.com/blog/2361214/202111/2361214-20211112124034423-253408954.png)

为了解决兜圈子问题，IEEE的802.1D标准制定了一个**生成树协议STP**，其要点的协议是不改变网络的实际拓扑，但在逻辑上切断某些链路。使得从一台主机到其他主机的路径是无环路的树状结构，从而避免广播风暴大量占用交换机的资源。

生成树STP协议原理：任意一交换机中如果到达根网桥有两条或者两条以上的链路，生成树协议都根据算法把其中一条切断，仅保留一条，从而保证任意两个交换机之间只有一条单一的活动链路。因为这种生成的拓扑结构，很像是以根交换机为树干的树形结构，故为生成树协议。

总线以太网使用了CSMA/CD协议，以半双工进行通信，但是以太网交换机采用的是全双工通信，并不是使用CSMA/CD协议，为什么还叫以太网？原因是它的**帧结构未发生变化，仍然采用以太网的帧结构**。

### 虚拟局域网

利用以太网交换机可以很方便的实现**虚拟局域网(VLAN)**，在IEEE802.1Q标准中，对虚拟局域网是这样定义的：虚拟局域网是由一些局域网网段构成的与物理位置无关的逻辑组，而这些网络具有某些共同的需求，每一个VLAN帧都有一个明确的标识符，指明发送这个帧的计算机属于哪一个VLAN。

## 本章重要的概念

* 链路是从一个节点到相邻节点的一段物理层线路，数据链路是在链路的基础上增加了一些必要的硬件(如网络适配器)和软件(如协议的实现)。

* 数据链路层使用的信道主要是点对点信道和广播信道两种。

* 数据链路层传送的协议数据单元是帧。数据链路层的三个基本问题是：封装成帧，透明传输，差错检测。

* 循环冗余检验CRC是一种检错方法，而帧检测序列FCS是添加在数据后面的冗余码。

* 点对点协议PPP是数据链路层使用最多的一个协议，它的特点是：简单，只检测差错，而不是纠正错误，不使用序列号，也不进行流量控制。可同时支持多种网络协议。

* PPoE是为宽带上网的主机使用的链路层协议。

* 局域网的优点是：
  * 具有广播功能，从一个站点可以很方便的访问全国。
  * 便于系统的扩展和演变。
  * 提高了系统的可靠性，可用性和生存性。

* 计算机与外界局域网的通信要通过通信适配器(或网络适配器),它又称为网络接口卡或网卡。计算机的硬件地址就在适配器的ROM中。

* 以太网采用无连接的工作方式,对发送的数据帧不进行编号,也不要求对方发回确
认。目的站收到有差错帧就把它丢弃,其他什么也不做。

* 以太网采用的协议是具有冲突检测的载波监听多点接入 CSMA/CD。协议的要点是:发送前先监听,边发送边监听,一旦发现总线上出现了碰撞,就立即停止发送。然后按照退避算法等待一段随机时间后再次发送。因此,每一个站在自己发送数据之后的一小段时间内，存在着遭遇碰撞的可能性。以太网上各站点都平等地争用以太网信道。

* 传统的总线以太网基本上都是使用集线器的双绞线以太网。这种以太网在物理上是星形网,但在逻辑上则是总线形网。集线器工作在物理层,它的每个接口仅仅简单地转发比特,不进行碰撞检测。

* 以太网的硬件地址,即MAC地址实际上就是适配器地址或适配器标识符,与主机
所在的地点无关。源地址和目的地址都是48位长。

* 以太网的适配器有过滤功能，它只接受单播帧，广播帧和多播帧。

* 使用集线器在物理层上扩展以太网(扩展后的以太网仍然是一个网络)。

* 交换式集线器常称为以太网交换机或第二层交换机(工作在数据链路层)。它就是
个多接口的网桥,而每个接口都直接与某台单主机或另一个集线器相连,且工作
在全双工方式。以太网交换机能同时连通许多对的接口,使每一对相互通信的主机
都能像独占通信媒体那样,无碰撞地传输数据。
