## 文件传输协议
### FTP概述

文件传输协议FTP(File Transfer Protocol)[RFC 959]是互联网上使用最广泛的文件传输协议，FTP提供交互式的访问，允许用户指明文件类型与格式，并允许文件是否具有存取权限等。FTP屏蔽了各计算机系统的细节，因而适合于在异构网络中任意计算机之间传送文件。

文件共享协议FTP一大类是**联机访问(online access)**。联机访问意味着允许多个程序对同一个文件进行存取，和数据库系统的不同之处是用户不需要调用一个特殊的客户进程，而是由操作系统提供对远程共享文件进行访问的服务。属于文件共享协议的有**网络文件系统NFS(Network File System)**,NFS可以使本地计算机远程共享远地的资源，就想这些资源在本地一样。NFS主要运用在TCP/IP网络上。 

### FTP的基本工作原理

在两台主机之间传递文件是一种非常大的挑战，因为不同的计算机厂商研制出的文件系统高达数百种，且差别很大，经常遇到的问题有：
1. 计算机存储数据的格式不同。
2. 文件的目录结构和文件命名不同。
3. 对于相同的文件存储功能，操作系统使用的命令不同。
4. 访问控制方法不同。

FTP只提供文件传送的基本的一些服务，它使用**TCP可靠的运输服务**，FTP主要的功能就是减少或者消除在不同操作系统下处理文件的不兼容性。

FTP使用**客户服务期方式**。一个FTP服务器进程可以同时为多个FTP客户进程提供服务。FTP的服务进程主要有两大类：
1. 一个主进程：负责接受新的请求。
2. 若干个从属进程，负责处理单个请求。

主进程的工作步骤：
1. 打开熟知端口号(21)，使得客户端进程能够连接得上。
2. 等待客户进程发出连接请求。
3. 启动从属进程处理客户进程发来的请求，从属进程对客户进程的请求处理完毕后就终止了，但从属进程在运行期间根据需要还可以创建其他一些子进程。
4. 回到等待状态，继续接受其他客户端进程发来的请求。主进程与从属进程是并发进行的

![](https://img2020.cnblogs.com/blog/2361214/202109/2361214-20210908163131860-284734360.png)

如上图，图中的椭圆形表示在系统中运行的进程，图中的服务器端有两个从属进程：**控制进程和数据传送进程**(图中服务器主进程没有画上)，客户端除了控制进程和数据传送进程之外，
还有一个用户界面进程用来和用户接口。

在进行文件传输时候，FTP的客户和服务器之间要建立**两个并行的TCP连接**:“连接控制”和“数据连接”，控制连接在整个会话期间一直保持打开，FTP客户发出的传送请求，通过
控制连接发给服务器端的控制进程，但控制进程并不是用来传送文件。**实际用来传送文件的是”数据连接“**。服务器端的控制进程在接收到TCP客户端发来的文件传输请求后就创建**数据传送进程**和**数据连接**，用来连接客户端，和服务器端的数据传送进程。数据传送进程实际完成文件的传输。在传送完毕后关闭“数据传送连接”并结束运行。由于FTP使用的是分离的控制连接，因此FTP的控制信息是**带外(out of band)**传送的。

当客户进程向服务器进程发出建立连接请求时，要寻找连接服务器进程的熟知端口号(21)，同时还要告诉服务器进程自己的另一个端口号码，用于建立数据传送连接，接着，服务器进程用自己传送的熟知端口20与客户进程所提供的端口号建立连接。由于 FTP使用了两个不同的端口号，所以数据连接与控制连接不会发生混乱。使用两个独立的端口连接的好处是使协议更加简单和容易的实现，同时在文件传输的时候还可以利用控制对文件的传输速进行控制。例如客户端发送**请求终止传输**。

然而网络文件系统NFS则采用的是另一种思路：**NFS允许应用进程打开一个远程文件，并能在该文件的某一个特定位置上开始读写数据。**这样，NFS用户可使用户只复制一个打文件中的一小部分，而并不需要复制整个文件。**在网络传送也只是少量的数据**。

### 简单文件传输协议TFTP(Trivial File Transfer System)

TCP/IP家族中有一个**简单文件传输协议TFTP**，它是很小且易于实现的文件传输协议。TFTP的版本2是互联网的正式标准[RTC 1350],虽然TFTP也使用的是客户服务器方式，但是它使用的是**UDP数据报**，因此TFTP需要有自己的差错处理机制。TFTP只支持文件传输并不支持交互，TFTP不能进行用户身份鉴别，没有列目录，没有庞大指令集。

TFTP主要有两个优点
1. **TFTP可用于UDP环境**，例如当需要将文件同时向许多机器下载的时候往往就需要TFTP。
2. **TFTP占用代码较少**，这对较小的计算机或者其他硬件设备来说是非常重要的，这些设备不需要硬盘，只需要固化好了TFTP,UDP和IP的小容量只读存储器即可，当接通电源后，设备执行只读存储器中的代码，在网络上广播一个TFTP请求。网络上的TFTP服务器就会响应，设备收到的文件后会放到内存中，然后开始运行内存，这种方式增加了灵活性，也减少了开销。

TFTP的主要特点是：
1. 每次传送的数据报文中有512字节的数据，但最后一次可不足512字节。
2. 数据报文按序编号，从1开始。
3. 支持ASCII码或二进制传送。
4. 可对文件进行读或者写。
5. 使用很简单的首部。

TFTP的工作就像停止等待协议。TFTP发完一个文件块后就等待对方的确认，确认时就应指明所确认的块编号。发完数据后在规定的时间内收不到确认就要重发数据协议数据单元PDU，发送确认PDU的一方若在规定时间内收不到下一个文件块，也要重发确认PDU，这样可以保证文件的传输不会因一个数据报的丢失而失败。

在一开始工作时，TFTP客户进程发送一个读请求报文或者写请求报文给TFTP服务器进程，其熟知端口号为**69**。TFTP服务器进程选择一条新的端口和TFTP客户进程进行通信。若文件长度刚好为512字节的整数倍，则在文件传输完毕后，还需要再发送一个只含首部而无数据的数据报文。若文件长度不是512的整数倍，则最后传送的数据报文中的数据字段一定不满512字节。这正好可以作为文件结束的标志。