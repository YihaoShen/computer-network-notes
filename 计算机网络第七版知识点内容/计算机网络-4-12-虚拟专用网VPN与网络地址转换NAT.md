## 虚拟专用网VPN与网络地址转换NAT

### 虚拟专用网VPN

由于IP地址资源的紧缺，一个机构申请到的IP地址远远少于本机构拥有的主机数。并且很多计算机并不需要和互联网相连。假设在一个机构内部的计算进通信也是采用TCP/IP协议，那么从原则上来讲，对于这些仅在内部机构使用的计算机就可以由本机机构**自行分配IP地址**，也就是说，让这些计算机使用仅在本机机构有效的IP地址（这种地址称之为本地地址），而并不需要向互联网的管理机构申请全球唯一IP地址（这种地址称之为全球地址）。这样就大大节约了宝贵的全球IP地址资源。

​但是，如果任意选择一些IP地址作为本机构内部使用的本地地址，那么在某种情况下可能会引起一些麻烦，例如，有时机构内部的某台主机需要和互联网连接，那么在这种仅在内部使用的本地地址快就有可能会和互联网上的某个IP地址重合，这样就会出现地址的二义性问题。

​为了解决这个问题，RFC1918指明了一些**专用地址（private address）**，这些地址只能用于一个机构的内部通信，而并不能用于和互联网上的主机通信。换言之，专用地址只能用于本地地址而不能用作全球地址。**在互联网上的所有路由器，对目的地址时专用地址的数据报一律不允许转发**。RFC6890全面的给出了所有特殊用途的IPV4地址，但三个专用地址块并未发生变化，即：

1. 10.0.0.0-10.255.255.255

2. 172.16.0.0-172.31.255.255

3. 192.168.0.0-192.168.255.255

采用这样的专用IP地址的互联网称之为**专用互联网或本地互联网或者专用网**，专用IP地址与有时候也叫做**可重用地址（reusable address）**。

有时候一个很大的机构的许多部门分布很广，这些部门要经常交互信息，这可以有两种办法：

1. 租用电信公司的通信线路为本机构专用。这种方法虽然简单方便，但是线路的租金太高，一般难以承受。

2. 利用公网的互联网络作为本机构各专用网之间的通信载体，这样的专用网又称之为**虚拟专用网VPN（Virtual Private Network）**。

之所以称之为"专用网"是因为这种网络是用于机构的主机内部通信使用。而并不是用于和网络外非机构的主机通信，**如果专用网不同网点之间的通信必须通过公用的互联网络，但又有保密的要求，那么所有通过互联网传输的数据包必须要加密，加密需要采用的协议将在以后讨论**。"虚拟"表示的是"好像是"，但实际上并不是，因为现在并没有真正的使用通信专线。而VPN只是在效果上和真正的专用网一样。一个机构要构建自己的VPN就必须为它的每一个场所购买专门的硬件和软件，并进行配置在，使每一个场所的VPN系统都知道其他场所的地址。

​如图4-59以两个场所为例说明如何使用IP隧道技术实现虚拟网络专用。

​ ![image](https://img2020.cnblogs.com/blog/2361214/202108/2361214-20210822173838482-515154534.png) 

​ 假如某个机构在两个相隔较远的场所建立了专用网A和B，其网络地址分别为10.1.0.0和10.2.0.0。现在这两个场所需要通过公网的互联网构成了一个VPN。显然，每一个场所至少要有一个路由器具有合法的全球IP地址。路由器R1和R2在专用网内部网络接口地址则是使用专用网的本地地址。

在每一个场所A或者B内部的通信通信量都不经过互联网。但如果场所A的主机X要和另一个场所的主机Y进行通信，那么就必须经过路由器R1和R2。主机X向主机Y发送到额IP数据报的源地址是10.1.0.1，而目的地址是10.2.0.3.这个数据报先作为本机构的内部数据报从X发送到与互联网连接的路由器R1，路由器R1在收到内部数据报后，发现其目的网络必须要通过互联网才能到达，就把整个数据报进行加密（这样就保证了内部数据包的安全），然后重新加上数据报的首部，封装成为互联网上发送的外部i数据报，其原地址是路由器R1的全球地址125.1.2.3，目的网络是192.4.5.6。路由器R2在接收到R1发送过来的数据报之后，将数据部分取出进行解密。恢复出原来的内部数据报（目的地址是10.2.0.3），交付主机Y。可见，虽然X向Y发送的数据报是通过了公用的互联网，但在效果上好像是在本部门的专用网传送一样。如果主机Y向X发送数据报，那么进行的步骤也是类似的。

注意，数据报从R1传送到R2可能要经过许多个路由器和网络。但从逻辑上来看，在R1和R2路由器之间好像是一条直通的点对点链路，图4-59（a）中的“隧道”就是这个意思。

如图4-59(b)所示的、由场所A和B的内部网络所构成的额虚拟专用网VPN又称之为**内联网（internat VPN）**，表示场所A和B都属于同一个机构。

### 网络地址转换NAT

下面讨论的是在专用网内部的一些主机本来就已经分配到了本地IP地址（本专用网内的专用地址），但现在又想和互联网上的主机通信（并不需要加密），那么应当采取什么措施？

最简单的办法就是设法再申请一些全球IP，但在这种情况下是不容易做大的，因为全球IPV4的地址已经所剩无几了，目前使用最多的是采用**网络地址转换协议**。

​ **网络地址转换NAT(Network address Translation)方法是在1994年提出的，这个方法需要在专用网的的路由器上安装NAT软件**，装有NAT软件的路由器叫做**NAT路由器**，它至少有一个有效的外部全球IP地址，这样，所有使用本地地址的主机在与外界通信时，都在在NAT路由器上将其本地地址转化为全球IP地址，才能和互联网连接。

图4-60给出了NAT路由器的工作原理。

​ ![image](https://img2020.cnblogs.com/blog/2361214/202108/2361214-20210822173905794-706147840.png) 

在图中，专用网192.168.0.0内所有主机的IP地址都是本地IP地址为192.168.x.x。NAT路由器至少要有一个全球IP地址，才能和互联网相连。

NAT路由器在接收到从专网内部主机A发往互联网上主机B的IP数据报：源IP地址是192.168.0.3，而目的地址为213.18.2.4。NAT路由器会把IP数据报的源IP地址192.168.0.3转为新的IP地址（即NAT路由器全球唯一IP地址）172.38.1.5，然后转发出去。因此，当主机B接收到这个IP数据报时，以为A的IP地址为172.38.1.5。当B给A发送IP数据报，IP数据报的目.的IP地址就是路由器NAT地址172.38.1.5。B并不知道A的专用地址为192.168.0.3，就算知道了也不能使用，因为互联网上的路由器不允许转发目的地址是专用网本地IP地址的IP数据报。当NAT路由器接收到互联网上的主机B发送过来的IP数据报，还要进行一次IP地址转换。通过NAT转换，就可以把IP为172.38.1.5转化为192.168.0.3（主机A的真正地址）。在NAT路由器中，还有一张NAT地址转化表，通过NAT地址转换表，第一列“方向”为“出”表示离开专用网。

![image](https://img2020.cnblogs.com/blog/2361214/202108/2361214-20210822173918974-1453152815.png)

由此可见，当NAT路由器具有n个全球IP地址时，专用网内最多同时有n太主机接入到互联网。这样就可以使专用网内较多数量的主机轮询使用NAT路由器的全球唯一IP地址。

​ 为了更加有效的利用NAT路由器的全球IP地址，现在 常用的NAT地址转换表把运输层的端口号也利用上，这样，就可以使多个拥有本地地址的主机，共用一个NAT路由器上的全球唯一IP地址，因而可以同时和互联网上的不同主机进行通信。

​ 使用端口号的NAT也叫做**网络地址与端口号转换（NAPT：Network Address And Port Translation）**，而并不使用端口号的NAT叫做传统的NAT。

![image](https://img2020.cnblogs.com/blog/2361214/202201/2361214-20220106141121717-822899787.png)
