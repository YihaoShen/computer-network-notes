## UDP用户数据报协议

#### UDP概述

用户数据报协议UDP只在IP的数据报服务之上增加了很少的一点功能，就是**复用，分用，差错检测功能**。UDP的主要特点是：

- UDP是**无连接的**，即在发送数据报之前不需要建立连接（当然发送数据结束的时候也不会有连接释放），因此减少了开销和发送数据之前的时延。

- UDP是**尽自己最大努力**交付，且并不提供可靠服务，因此主机并不需要维持复杂的链接状态表。

- UDP是**面向报文的**，发送方的UDP对应用程序交下来的报文，在添加首部之后就可以交付给IP层。UDP对于应用层交付下来的报文，**既不拆分，也不合并**，只是只是**保留这些报文的边界**。意思就是，不管上层传给UDP多长的报文，UDP照样发送，至于是否进行切片处理等等，那是IP层的事情。

![image](https://img2020.cnblogs.com/blog/2361214/202108/2361214-20210826010333805-547265007.png)

- UDP没有拥塞控制，因此网络上出现拥塞不会使得源主机的发送速率降低。这种就特别的适合实时场景的使用。例如视频通话，语音通话等等。

- UDP支持一对一，一对多，多对一，多对多的交互通信。

- UDP的首部开销小，相比TCP的20字节，只有8字节。

#### UDP的首部格式：

![image](https://img2020.cnblogs.com/blog/2361214/202108/2361214-20210826010454004-682953560.png)

1. 源端口（两个字节）：源端口号。不需要的时候用全0

2. 目的端口（两个字节）：目的端口号。

3. 长度（两个字节）：UDP用户数据报的长度，其最小值为8（仅含首部）。

4. 检验和（2字节）：检测UDP用户数据包在传输中是否出错。有错就丢弃。

当运输层从IP层接收到UDP数据报的时候，就根据首部中的目的端口，把UDP数据报通过相应的端口，最终交付给相应的应用进程处理。如图5-6

![image](https://img2020.cnblogs.com/blog/2361214/202108/2361214-20210826010509454-13784060.png)

如果接收方UDP接收到的目的端口号不明确（即不存在相应的目的端口号），就丢弃这个UDP报文，并由网际控制报文协议（ICMP）发送**端口不可达**差错报文给发送方。

请注意，虽然在UD P之间的通信需要使用到**端口号**，但由于UDP通信是无连接的，因此并不需要使用**套接字socket**（TCP之间就要必须使用socket建立连接）。

UDP用户数据报首部中校验和的计算方法有些特殊。在计算校验和的时候，要在UDP用户数据报之前加上12字节的**伪首部**，所谓的伪长度是因为者追踪伪长度并不是UDP用户数据真正的首部。只是在校验和的时候，临时加到UDP数据报的前面，得到一个临时的UDP用户数据报，（伪首部的第三个字段全是0，第四个字段是IP首部中的协议字段，以前讲过，对于UDP，就是17；第五个字段是UDP用户数据包的长度。因此检验和，既检查了UDP用户数据报的源端口号和目的端口号以及检查了UDP用户数据包的数据部分，又检查了IP数据报的源IP地址和目的IP地址）。检验和就是根据这个UDP临时数据报来计算的，**伪长度既不向下传送也不向上递交，而仅仅是为了计算校验和。**，至于怎么校验呢？其实UDP计算校验和的方法和计算IP数据报的首部校验和的方法类似。但不同的是：**IP数据报的检验和只校验IP数据报的首部，但是UDP检验和是把首部和数据部分一起校验**。在发送方，首先把全0放到校验和字段中。再把伪首部UDP用户数据报看成是由许多16位的字符拼接起来的。若UDP用户数据报的数据部分不是偶数字节，则要填入一个全零字节（但此字节不发送），然后按照二进制反码计算出这些16位字的和，将此和的二进制反码写入校验和字段后，就发送这样的UDP用户数据报。在接收方，把收到的UDP用户数据报连同**伪首部**一起，按二进制反码求出16位字的和，当无差错时，其结果为1，否则就是出现差错，接收方就应该丢弃这个UDP报文，并把错误信息通过ICMP(网际控制协议)差错报告给上层。这种简单的差错检测方法能力并不强，但它的好处是简单，处理起来比较快。

![image](https://img2020.cnblogs.com/blog/2361214/202201/2361214-20220116111332388-1176921235.png)

如上图5-5所示，伪首部的第3个字段全是0，第四个字段是IP首部的协议字段的值。以前已经讲过，对于UDP，此协议字段值为17；第5字段是UDP用户数据报的长度。因此，这样的检验和，既检查了UDPO用户数据报的源端口号和目的端口号以及UDP用户数据报的数据部分，又检查了IP数据报的源IP地址和目的地址。
