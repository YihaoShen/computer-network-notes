## IPv6

IP是互联网的核心，现在使用的IP地址经过发展，已经在2011年2月耗尽。解决IP地址耗尽的根本措施就是使用更大地址空间的新版本IP即IPv6。

### IPV6的基本首部：

IPv6仍然是无连接传送，但是将协议数据单元PDU称之为**分组**，而不是IPv4的**数据报**。

IPv6的主要变化如下：

1.  **具有更大的地址空间**：IPv6把地址从IPV4的32位增大了4倍，即增加到128倍，使得地址空间增大了$2^{96}$倍，这样大的地址在未来可预见的时间内是用不完的。

2.  **扩展的地址层次结构**：IPv6由于地址空间很大，因此可以划分为更多的层次。

3.  **灵活的首部格式**：IPv6和IPv4的数据报首部并不兼容。IPv6定了许多可选的扩展首部。\*\*不仅可以提供比IPv4更多的功能，还可以提高路由器的处理速度。\*\*这是因为路由器对扩展首部不进行处理。

4.  **改进的选项**：IPv6允许数据报包含有选项的控制信息，因此可以包含新的选项。但是IPv6的首部长度是固定不变的。

5.  **允许协议继续扩充**：因为技术在不断发展，新的应用也会出现，但是IPv4的功能是固定不变的。

6.  **支持即插即用（即自动配置）**：IPv6协议不需要使用DHCP。

7.  **支持资源的预分配**：IPv6支持实时视频等要求保证一定的带宽和时延的应用。

8.  **IPv6首部改为8字节对齐（即首部长度必须是8字节的整数倍）**：原来的IPv4首部长度是4字节对齐。

IPv6数据报两大部分组成：**基本首部**和**有效载荷有效载荷（净负荷）**。有效载荷允许有零个或者多个扩展首部，再后面是数据部分。

![image](https://img2020.cnblogs.com/blog/2361214/202108/2361214-20210818130756044-580154821.png)

与IPv4相比，IPv6的首部对某些字段进行了如下的改变：

1.  取消了首部长度字段，因为IPV6的首部长度固定为40字节。

2.  取消了服务类型字段，因为优先级和流水号字段实现了服务类型字段的功能。

3.  取消了总长度字段，改用有效载荷长度字段。

4.  取消了标识，标志，片偏移量，因为这些功能已经包含在分片扩展首部中。

5.  把TTL字段改为跳跃限制字段，但作用是一样的。

6.  取消了协议字段，改用下一个首部字段。

7.  取消了检验和字段，这样就加快了路由器处理数据报的速度。

8.  取消了选项字段，而用扩展首部来实现选项功能。

    ![image](https://img2020.cnblogs.com/blog/2361214/202108/2361214-20210818130813343-1028502871.png)

下面解释IPv6基本首部各字段的作用：

1.  **版本（version）**：占4位，表明协议的版本，对于IPv6来说，该字段为6。

2.  **通信量类（traffic class）**：占8位，为了区分不同的IPv6数据报类别或优先级，目前只是进行不同的通信量类性能的实验。

3.  **流标号（flow label）**：占20位。IPV6一个新的机制就是支持资源预分配，并且允许路由器把一个数据报与一个给定的资源分配相联系。IPv6提出了一个**流**的概念，**流就是互联网上从特定源点到特定终点（单播或多播）的一系列数据报（如实时语音或者视频），而这个流所经过的路径上的路由器都能保证指明的服务质量**。凡是流经过的路由器，服务质量都可以得到保证。所有属于同一个流的数据报都有相同的流标号。

4.  **有效载荷长度（payload length）**：占16位，他指明IPv6数据报除了基本首部以外的字节数（所有扩展首部字节数都算在在内），这个字段的最大长度为**64KB（65535字节）**。

5.  **下一个首部（next header）**：占8位，它相当于IPV4的协议字段或者可选字段。

    *   当IPV6数据报没有扩展首部时，下一字段的作用就是和IPV4的协议字段一样，它的值指出了基本首部后面数据应该交付给IP层上面的高层协议（例如6代表交付给TCP层，17交付给UDP层）。

    *   当出现扩展首部时，下一首部的字段的值就标识后面第一个扩展首部的类型。

6.  **跳数限制（hop limit）**：占8位，用来防止数据报在网络中无限存在，源点在每个数据报发出时设定某个跳数限制（最大为255跳），每个路由器在转发数据报时，要先把跳数-1，当跳数为0，路由器就会把这个数据报丢弃。

7.  **源地址**：占128位，是数据包发送端的IP地址。

8.  **目的地址**：占128位，是数据包接受端的IP地址。

### IPv6的地址

一般来讲，一个IPv6数据报的目的地址可以是以下3种基本类型地址之一：

1.  **单播（unicast）**：传统的点对点通信。

2.  **多播（multicast）**：一对多通信

3.  **任播（anycast）**：IPv6新增的类型，任播的终点是一组计算机，但数据报只交付其中的一个，通常是距离最近的一个。

IPv6把实现IPv6协议的主机或者路由器均称之为**结点**，由于一个结点可能有多个与链路相连的接口，因此，IPv6给每一个结点指派一个IP地址，一个结点可以有多个单播地址，与其中任何一个地址都可以当做到达该结点的目的地址。

IPv6使用**冒泡十六进制记法**，例如**68E6:8C64:FFFF:FFFF:0:1180:960A:FFFF**

常见的IPv6地址分类：
![image](https://img2020.cnblogs.com/blog/2361214/202108/2361214-20210818130834904-1890041860.png)

*   **未指明地址**：这是16字节全为0的地址，可以缩写为两个冒号“：：”。这个地址不能用做目的地址，而只能用作某台主机当作源地址使用。这类地址仅此一个

*   **环回地址**：IPv6的环回地址是0：0：0：0：0：0：0：1，可以缩写为：：1。它的作用是和IPv4的环回地址一样。这类地址仅此一个。

*   **多播地址**：功能和IPv4一样，这类地址站占IPv6地址总数的1/256。

*   **本地链路多播地址（Link-Local Unicast Address）**：有些网络使用的TCP/IP协议的，**但并没有连接到互联网上**。连接在这样的互联网上的主机都可以使用这种本地地址进行通信，但不能和其他互联网上的其他主机通信。这类地址占IPv6总地址数的1/1024。

*   **全球单播地址**：IPv6的这一类单播地址是使用最多的一类。如图4-48所示，可以把整个128比特都作为一个结点的地址。也可以使用n比特作为子网前缀，用剩下的(128-n)比特作为接口标识符（相当于IPv4的主机号）。当然也可以划分三级，用n比特作为全球路由选择前缀，用m比特作为子网前缀，而用剩下的（128-n-m）比特作为接口标识符。

![image](https://img2020.cnblogs.com/blog/2361214/202112/2361214-20211222184205531-1160476669.png)

### 从IPv4向IPv6过度

由于现在互联网规模很大，一次性从IPv4过渡到IPv6显然是不可能的，因此过渡到IPv6**只能采用逐步演进的办法，同时新安装的IPv6系统还要向后兼容IPv4协议**。也就是说，IPv6系统除了处理IPv6报文，还要能够处理IPv4 的报文。

以下介绍过渡到IPV6的协议策略，即使用双协议栈和使用隧道技术\[RFC 2473，2529，3056，4038，4212]。

#### 双协议栈策略

**双协议栈（dual stack）**：指的是在完全过渡到IPv6协议之前，使得一部分主机（或者路由器）装有双协议栈：一个IPv4和一个IPv6。因此双协议栈主机（路由器）既能够和IPv4的系统通信，也能和IPv6的系统通信。双协议栈的主机（路由器叫做）IPV4/IPV6，表明它同时具有两种IP地址：一个IPv4地址，一个IPv6地址。那么双协议栈主机怎么知道目的主机是采用哪一种地址呢？**它使用DNS域名来查询。若DNS返回的是IPv4地址，双协议栈就采用IPv4地址，若DNS服务器返回的是IPv6，那么双协议栈就采用IPv6地址。**

图4-49所示的情况是源主机A和目的主机F都使用IPv6，所以A向F发送IPv6数据报，路径是A->B->C->D->E->F。中间B到E是IPv4网络，路由器B不能向路由器C转发IPv6数据报，因为路由器C只使用IPv4协议。B是IPv6到IPv4路由器，它把IPv6数据报首部转化为IPv4数据报首部发送给C，C再发送给D。当D转发到IPv4网络的出口路由器E时（E也是IPv4/IPv6路由器），再恢复成原来的IPv6数据报。需要注意的是：IPv6首部中**某些字段无法恢复**，例如原来IPv6首部中的流标号X在恢复后可能变为空缺。这样的信息损失是使用首部转化放啊不可避免的。

![image](https://img2020.cnblogs.com/blog/2361214/202112/2361214-20211222184235241-1702968343.png)

#### 隧道技术

隧道技术（tunneling），这种方法的工作要点是在IPv6数据报要进入IPv4网络的时候，把整个IPv6数据报封装成IPv4数据报。现在整个IPv6部分都成了IPv4数据报的数据部分。这样的IPv4数据报从路由器B进入路由器C和D，传到E，而原来的IPv6数据报就好像在IPV4网络的隧道中传输，没有发生什么变化。当IPv4数据报离开IPv4网络中的隧道的时候，再把数据部分（即原来的IPv6数据报）交给IPV6协议栈。图中一条粗线表示在IPv4网络中好像有一个从B到E的“IPv6隧道”，路由器B是隧道的入口而E是出口。注意：**在隧道中传送的数据报的源地址是B而目的地址是E**。

要使得双协议栈主机知道IPv4数据报里封装的是一个IPv6的数据报，就必须把IPv4的首部的协议字段设置为41（41代表的是数据报里面的数据部分是IPv6数据报）。

![image](https://img2020.cnblogs.com/blog/2361214/202108/2361214-20210818130851821-1383980107.png)

### ICMPV6：

和IPv4一样，IPv6也不能保证数据报的可靠交付，因为互联网中的路由器可能会丢弃数据报，因此IPv6也需要使用ICMP来反馈一些差错信息。新的版本称之为ICMPv6，它比ICMPv4要复杂的多，地址解析协议（ARP）和网际组管理协议（IGMP）的功能都已经被合并到ICMPv6中（如图4-51）。

![image](https://img2020.cnblogs.com/blog/2361214/202108/2361214-20210818130921600-83029626.png)

ICMPv6是面向报文的协议，它利用报文来报告差错，获取信息，探测邻站，管理多播通信。

![image](https://img2020.cnblogs.com/blog/2361214/202112/2361214-20211222184328601-339979022.png)
