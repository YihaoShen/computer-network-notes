## 电子邮件

### 电子邮件概述

实时通信的电话有两个很严重的缺点：

1. 电话通信的主叫和被叫必须同时在场。

2. 有些电话常常不必要地打断被叫者的工作或者休息。

电子邮件(e-mail)**是互联网上使用最多和最受欢迎的一种应用。电子邮件把邮件发送到收件人使用的邮件服务器，并放在其中的收件人**邮箱(mail box)\*\*中，收件人可在自己方便时上网到自己使用的邮件服务器进行读取。电子邮件最主要的两个标准是：

1. 简单邮件传送协议SMTP(Simple mail Transfer Protocol)

2. 互联网文本报文格式

由于互联网的SMTP只能传送可打印的7位ASCII码邮件，因此在1993年又提出了**通用互联网邮件扩充MIME(Multipurpose Internet Mail Extensions)**。MIME在其邮件首部中说明了邮件的数据类型(如文本、声音、图像、视频等)。

一个电子邮件系统应该具有以下三个主要结构(如图6-17)：这就是用户代理，邮件服务器，邮件发送协议(SMTP)和邮件读取协议(POP3，**邮局协议(Post Office Protocol) V3**)。

![image](https://img2020.cnblogs.com/blog/2361214/202109/2361214-20210910212546241-1766088388.png)

* 用户代理UA(User Agent)就是用户与电子邮件的接口，大多数情况下是运行在用户电脑中的程序。因此用户代理又称之为**电子邮件客户端软件**，来用发送和接收邮件。用户代理至少应该具备以下种条件：

    1.  撰写：给用户提供编写信件的环境。

    2.  显示：能够展示邮件内容。

    3.  处理：包括发送和接收邮件。

    4.  通信：发信人写完邮件后利用邮件发送协议发送邮件。收件人利用邮件读取协议接收邮件。

邮件服务器按照**客户服务器方式**工作。邮件服务器需要使用**两种不同的协议**。一种协议用户用户代理向邮件服务器发送邮件或者在邮件服务器之间发送邮件，如SMTP协议。而另一种协议使用用户代理从邮件服务器**读取邮件**，如邮局协议POP3。

电子邮件一般由信封和内容两部分组成。在邮件的信封上，最重要的是收件人的地址，TCP/IP协议的电子邮件系统规定电子邮件地址格式如下：**用户名@邮件服务器的域名**。

### 简单邮件传送协议

SMTP协议规定了在两个互相通信的SMTP进程之间应该如何交换信息，由于SMTP使用的是**客户服务器**方式，因此发送邮件的SMTP进程就是SMTP客户，而负责接收邮件的SMTP进程就是SMTP服务器，至于邮件内部的格式、邮件如何存储等，这些SMTP都未作出规定。

#### 1. 连接建立

发件人的邮件发送到发送方邮件服务器的邮件缓存后，SMTP客户就每隔一段时间（例如30min）就对邮件缓存扫描一次。如果发现有邮件，就使用SMTP熟知的端口号码**25**与接收方邮件的SMTP服务器建立TCP连接，在连接建立后。接收方SMTP就发出**220 Service ready(服务就绪)**，然后SMTP客户就向SMTP服务器发送**HELO**命令，附上发送方的主机名，SMTP若有能力接收邮件，则回答：“250 OK”，表示已经准备好接收，若SMTP服务器不可用，则回答:"421 Service not available(服务不可用)"。如果在一定时间内(例如三天)发送不了邮件，邮件服务器会把这个情况通知发件人。**SMTP不使用中间的邮件服务器**，不管发送方和接收方的邮件服务器相隔多远，不管在邮件传送过程中要经过多少个路由器，TCP 连接总是在发送方和接收方这两个邮件服务器之间直接建立。当接收方邮件服务器出故障而不能工作时，发送方邮件服务器只能等待段时间后再尝试和该邮件服务器建立 TCP 连接，而不能先找一个中间的邮件服务器建立TCP连接。

#### 2. 邮件传送

邮件传送从MAIL命令开始的。MAIL命令后面跟着发件人的地址。如：MAIL FROM <heiye@qq.com>。若SMTP服务器已经准备接受好邮件，则回答”250 OK“，否则返回一个代码，例如：451（处理时出错），452（存储空间不够），500（下面就跟着一个或者多个RCPT命令，用于把邮件发送给收件人，例如：RCPT TO:<收件人地址>。接下来是DATA命令，表示要发送的邮件内容了。

#### 3. 连接释放邮件发送完毕后,SMTP客户应该发送一个QUIT命令。SMTP服务器返回的是”221（服务关闭）“表示SMTP同意释放TCP连接，邮件传送过程结束。

#### SMTP缺点

1. 发送邮件不需要鉴别，这样在FROM命令后面的地址可以自由地编写，**这样就大大方便了垃圾邮箱的制造者**。
2. SMTP传输的邮件是明文，不利于保密。

### 邮件读取协议POP3和IMAP
现在常用的邮件读取协议有两个：
1. POP3（邮局协议第三个版本）:
POP3邮局协议是一个非常简单的，但功能有限的邮件读取协议。POP3也使用**客户服务器**的工作方式，在接收邮件的用户计算机中的用户代理必须运行POP3客户端程序，而在收件人的邮件服务器中则运行POP3服务器程序，当然，这个邮件服务器还要运行SMTP服务器程序。**POP3服务器只有在用户输入鉴别信息（例如用户名和口令）后才允许对邮箱进行修改**。

2. 网际报文存储协议IMAP4(Internet Message Access Protocol Version 4)。
在使用 IMAP 时，在用户的计算机上运行 IMAP 客户程序，然后与接收方的邮件服务器上的 IMAP 服务器程序建立 TCP 连接。用户在自己的计算机上就可以操纵邮件服务器的邮箱，就像在本地操纵一样，因此IMAP是一个联机协议。当用户计算机上的 IMAP 客户程序打开 IMAP 服务器的邮箱时，用户就可看到邮件的首部。若用户需要打开某个邮件，则该邮件才传到用户的计算机上。用户可以根据需要为自己的邮箱创建便于分类管理的层次式的邮箱文件夹，并且能够将存放的邮件从某一个文件夹中移动到另一个文件夹中。用户也可按某种条件对邮件进行查找。在用户未发出删除邮件的命令之前，IMAP 服务器邮箱中的邮件一直保存着。

下图给出IMAP和POP3的主要功能的比较：
![image](https://img2020.cnblogs.com/blog/2361214/202109/2361214-20210910212605419-1503202661.png)

### 基于万维网的电子邮件

万维网电子邮件的好处就是：不管在什么地方（在任何一个国家的网吧、宾馆或朋友家中），只要能够找到上网的计算机，在打开任何一种浏览器后，就可以非常方便地收发电子邮件。使用万维网电子邮件不需要在计算机中再安装用户代理软件。浏览器本身可以向用户提供非常友好的电子邮件界面（和原来的用户代理提供的界面相似），使用户在浏览器上就能够很方便地撰写和收发电子邮件。

用户在浏览器浏览各种信息采用HTTP协议。因此，在浏览器和互联网上得邮件服务器之间传送邮件时，仍然使用HTTP协议，但在各邮件服务器之间采用SMTP协议。

