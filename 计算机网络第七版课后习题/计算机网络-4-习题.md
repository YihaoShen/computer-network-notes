### 网络层章节重要概念

* TCP/IP体系中的网络层向上只提供**简单灵活、无连接、尽最大努力**的数据报服务。**网络层不提供服务质量承诺**，不保证分组交换的时限，所传送的分组可能出现出错、丢失、重复和失序。进程之间通信的可靠性由**运输层**负责。

* IP 网是虚拟的，因为从网络层上看，IP 网就是一个统一的、抽象的网络（实际上是异构的）。IP 层抽象的互联网屏蔽了下层网络很复杂的细节，使我们能够使用统一的、抽象的IP地址处理主机之间的通信问题。

* 在互联网上的交付有两种：在本网络上的直接交付（不经过路由器）和到其他网络的间接交付（经过至少一个路由器，但最后一次一定是直接交付）。

* 一个IP 地址在整个互联网范围内是唯一的。分类的 IP 地址包括A类、B类和C。类地址（单播地址），以及 D 类地址（多播地址）。E 类地址未使用。

* 分类的 IP 地址由网络号字段（指明网络）和主机号字段（指明主机）组成。网络号字段最前面的类别位指明 IP 地址的类别。

* IP 地址是一种分等级的地址结构。IP 地址管理机构在分配 IP 地址时只分配网络号，而主机号则由得到该网络号的单位自行分配。路由器仅根据目的主机所连接的网络号来转发分组。

* IP 地址标志一台主机（或路由器）和一条链路的接口。多归属主机同时连接到两个或更多的网络上。这样的主机同时具有两个或更多的 IP 地址，其网络号必须是不同的。由于一个路由器至少应当连接到两个网络，因此一个路由器至少应当有两个不同的 IP 地址。

* 按照互联网的观点，用转发器或网桥连接起来的若干个局域网仍为一个网络。所有分配到网络号的网络（不管是范围很小的局域网，还是可能覆盖很大地理范围的广域网）都是平等的。

* 硬件地址是数据链路层和物理层使用的地址，而IP地址是网络层和以上各层使用的地址，是一种逻辑地址，在数据链路层看不见IP地址。

* IP 数据报分为首部和数据两部分。首部的前一部分是固定长度，共 20 字节，是所有 IP 数据报必须具有的（源地址、目的地址、总长度等重要字段都在固定首部中）。一些长度可变的可选字段放在固定首部的后面。

* IP 首部中的生存时间字段给出了 IP 数据报在互联网中所能经过的最大路由器数，可防止IP数据报在互联网中无限制地兜圈子。

* 地址解析协议 ARP 把 IP 地址解析为硬件地址，它解决同一个局域网上的主机或路由器的 IP 地址和硬件地址的映射问题。ARP 的高速缓存可以大大减少网络上的通信量。

* 在互联网中，我们无法仅根据硬件地址寻找到在某个网络上的某台主机。因此，从IP 地址到硬件地址的解析是非常必要的。

* 无分类域间路由选择 CIDR 是解决目前 IP 地址紧缺的一个好方法。CIDR 记法把IP 地址后面加上斜线“/”，然后写上前缀所占的位数。前缀（或网络前缀）用来指明网络，前缀后面的部分是后缀，用来指明主机。CIDR 把前缀都相同的连续的 IP地址组成一个“CIDR 地址块”。IP 地址的分配都以 CIDR 地址块为单位。

* CIDR 的32位地址掩码（或子网掩码）由一串 1 和一串 0 组成，而 1 的个数就是前缀的长度。只要把 IP 地址和地址掩码逐位进行“逻辑与（AND）”运算，就很容易得出网络地址。A 类地址的默认地址掩码是 255.0.0.0。B 类地址的默认地址掩码是255.255.0.0。(C类地址的默认地址掩码是255.255.255.0。

* 路由聚合（把许多前缀相同的地址用一个来代替）有利于减少路由表中的项目，减少路由器之间的路由选择信息的交换，从而提高了整个互联网的性能。

* “转发”和“路由选择”有区别。“转发”是单个路由器的动作。“路由选择”是许多路由器共同协作的过程，这些路由器相互交换信息，目的是生成路由表，再从路由表导出转发表。若采用自适应路由选择算法，则当网络拓扑变化时，路由表和转发表都能够自动更新。在许多情况下，可以不考虑转发表和路由表的区别，，而都使用路由表这一名词。

* 自治系统（AS）就是在单一的技术管理下的一组路由器。个自治系统对其他自治系统表现出的是一个单一的和一致的路由选择策略。

* 路由选择协议有两大类：内部网关协议（或自治系统内部的路由选择协议），如RIP 和 OSPF；外部网关协议（或自治系统之间的路由选择协议），如 BGP-4。

* RIP 是分布式的基于距离向量的路由选择协议，只适用于小型互联网。RIP 按固定的时间间隔与相邻路由器交换信息。交换的信息是自己当前的路由表，即到达本自治系统中所有网络的（最短）距离，以及到每个网络应经过的下一跳路由器。

* OSPF 是分布式的链路状态协议，适用于大型互联网。OSPF 只在链路状态发生变化时，才向本自治系统中的所有路由器，用洪泛法发送与本路由器相邻的所有路由器的链路状态信息。“链路状态”指明本路由器都和哪些路由器相邻，以及该链路的“度量”。“度量”可表示费用、距离、时延、带宽等，可统称为“代价”。所有的路由器最终都能建立一个全网的拓扑结构图。

* BGP-4是不同AS的路由器之间交换路由信息的协议，是一种路径向量路由选择协议。BGP 力求寻找一条能够到达目的网络（可达）且比较好的路由（不兜圈子），而并非要寻找一条最佳路由。

* 网际控制报文协议 ICMP 是 IP 层的协议。ICMP 报文作为 IP 数据报的数据，加上首部后组成 IP 数据报发送出去。使用 ICMP 并非为了实现可靠传输。ICMP 允许主机或路由器报告差错情况和提供有关异常情况的报告。ICMP 报文的种类有两种，即 ICMP 差错报告报文和 ICMP 询问报文。

* ICMP的一个重要应用就是分组网间探测 PING，用来测试两台主机之间的连通性。PING 使用了 ICMP 回送请求与回送回答报文。

* 要解决 IP 地址耗尽的问题，最根本的办法就是采用具有更大地址空间的新版本的IP 协议，即 IPv6。

* IPv6 所带来的主要变化是：(1) 更大的地址空间（采用 128 位的地址）；(2) 灵活的首部格式；(3) 改进的选项；(4) 支持即插即用；(5) 支持资源的预分配；(6) IPv6首部改为8字节对齐。

* IPv6 数据报在基本首部的后面允许有零个或多个扩展首部，再后面是数据。所有的扩展首部和数据合起来叫做数据报的有效载荷或净负荷。

* IPv6数据报的目的地址可以是以下三种基本类型地址之一：单播、多播和任播。IPv6 的地址使用冒号十六进制记法。

* IPv6 I的地址使用冒号十六进制记法。

* 向IPv6 过渡只能采用逐步演进的办法，必须使新安装的IPv6系统能够向后兼容。向IPv6 过渡可以使用双协议栈或使用隧道技术。

* 与单播相比，在一对多的通信中，IP 多播可大大节约网络资源。IP 多播使用 D 类IP 地址。IP 多播需要使用网际组管理协议 IGMP 和多播路由选择协议。

* 虚拟专用网VPN利用公用的互联网作为本机构各专用网之间的通信载体。VPN内部使用互联网的专用地址。一个 VPN 至少要有一个路由器具有合法的全球 IP 地址，这样才能和本系统的另一个 VPN 通过互联网进行通信。所有通过互联网传送的数据都必须加密。

* 使用网络地址转换NAT技术，可以在专用网络内部使用专用IP地址，而仅在连接到互联网的路由器使用全球IP 地址。这样就大大节约了宝贵的IP 地址。

* MPLS 的特点：(1) 支持面向连接的服务质量；(2) 支持流量工程，平衡网络负载；(3) 有效地支持虚拟专用网 VPN。

* MPLS 在入口结点给每一个IP数据报打上固定长度的“标记”，然后根据标记在第二层（链路层）用硬件进行转发（在标记交换路由器中进行标记对换），因而转发速率大大加快。

### 

### 习题

**4.1 网络层向上提供的服务有哪两种？试比较其优点和缺点。**

> 解：网络层向上层提供的服务有两种：面向连接服务（虚电路服务）和无连接服务（数据报服务），主要区别如下所示：
> 
> | 对比的方面         | 虚电路服务                   | 数据报服务                     |
> | ------------- | ----------------------- | ------------------------- |
> | 思路            | 可靠通信应当由网络来保证            | 可靠通信应当由用户主机来保证            |
> | 连接的建立         | 必须有                     | 不需要                       |
> | 终点地址          | 仅在连接建立阶段使用，每个分组使用短的虚电路号 | 每个分组都有完整的地址               |
> | 分组的转发         | 属于同一条虚电路的分组均按照同一路由进行转发  | 每个分组独立选择路由进行转发            |
> | 当结点出现故障时      | 所有通过出故障的结点的虚电路均不能工作     | 出故障的结点可能会丢失分组，一些路有可能会发生变化 |
> | 分组的顺序         | 总是按照发送顺序到达终点            | 到达终点时不一定按照发送顺序            |
> | 端到端的流量控制和差错处理 | 可以由网络负责，也可以由用户主机负责      | 由用户主机负责                   |

**4.2 网络互连有何实际意义？进行网络互连时，有哪些共同的问题需要解决？**

> 解：我们知道，不可能让所有的用户都使用相同的网络。虽然这样做可使网络互连变得比较简单，但在实际上是不可行的。这是因为用户的需求是多种多样的，没有一种单一的网络能够适应所有用户的需求。另外，网络技术是不断发展的，网络的制造厂家也要经常推出新的网络，在竞争中求生存。因此在市场上总是有很多种不同性能、不同网络协议的网络，供不同的用户选用。因此我们面临的现实就是：在客观上，世界上有很多特性各异的网络，但这些网络又希望能够相互通信，于是网络互连的意义就是非常重要的。
> 
> 网络互联会遇到很多问题需要解决，例如：
> 
> - 不同的寻址方案
> 
> - 不同的最大分组长度
> 
> - 不同的网络接入机制
> 
> - 不同的超时控制
> 
> - 不同的差错恢复方案
> 
> - 不同的状态报告方法
> 
> - 不同的路由选择技术
> 
> - 不同的用户接入控制
> 
> - 不同的服务（面向连接服务还是无连接服务）
> 
> - 不同的管理与控制方式等等

**4.3 作为中间设备，转发器、网桥、路由器和网关有何区别？**

> 解：解答：将网络互相连接起来要使用一些中间设备。根据中间设备所在的层次，
> ，可以有以下四种不同的中间设备：
> 
> - 物理层使用的中间设备叫做转发器。
> 
> - 数据链路层使用的中间设备叫做网桥或者桥接器。
> 
> - 网络层使用的中间设备叫做路由器。
> 
> - 在网络层使用的中间设备叫做网关。

**4.4 试简单说明下列协议的作用IP, ARP, RARP 和 ICMP**

> - 网际协议IP：使用IP协议就可以把互联以后的计算机网络看成一个虚拟互联网络。所谓虚拟互连网络也就是逻辑互连网络，或称为互联网。我们知道，各种物理网络的异构性本来是客观存在的,但是我们利用IP协议就可以使这些性能各异的网络在网络层上看起来好像是一个统一的网络。这种使用IP协议的虚拟互连网络可简称为IP网。使用IP网的好处是：当IP网上的主机进行通信时，就好像在一个单个网络上通信一样，它们看不见互连的各网络的具体异构细节（如具体的编址方案、路由选择协议，等等）。
> 
> - 地址解析协议ARP：用来把一个机器（主机或路由器）的IP地址转换为相应的物理地址（或硬件地址）。
> 
> - 逆地址解析协议 RARP：和ARP相反，用来把一个机器（主机或路由器）的物理地址（或硬件地址）转换为相应的 IP 地址。
> 
> - 网际控制报文协议 ICMP：用来使主机或路由器报告差错情况和提供有关异常情况的报告，这样就可以更有效地转发IP数据报和提高交付成功的机会。

**4.5 IP 地址分为几类？各如何表示地址的主要特点是什么？**

> 解：在IPv4当中，所有的地址都是32位，并且可以记作为：IP地址={<网络号>+<主机号>}
> 
> IP地址共分为5类：
> 
> - A类地址：网络号字段为 1 字节，最前面的 1 位是 0。
> 
> - B类地址：网络号字段为2字节，，最前面的2位是10。
> 
> - C类地址：网络号字段为3字节，最前面的3位是110。
> 
> - D类地址：用于多播，最前面的4位是1110。
> 
> - E类地址：保留今后使用，最前面的 4 位是1111。
> 
> IP地址具有如下重要特点：、
> 
> 1. 每一个IP 地址都由网络号和主机号两部分组成。从这个意义上说，IP 地址是一种分等级的地址结构。
> 
> 2. 实际上 IP 地址是标志一个主机（或路由器）和一条链路的接口。换言之，IP 地址并不仅仅指明一个主机，同时还指明了主机所连接到的网络。
> 
> 3. 按照互联网的观点，一个网络是指具有相同网络号 net-id 的主机的集合，因此，用转发器或网桥连接起来的若干个局域网仍为一个网络，因为这些局域网都具有同样的网络号。具有不同网络号的局域网必须使用路由器进行互连。
> 
> 4. 在 IP 地址中，所有分配到网络号的网络（不管是范围很小的局域网，还是可能覆盖很大地理范围的广域网）都是平等的。

**4.7 试说明IP 地址与硬件地址的区别。为什么要使用这两种不同的地址？**

> 解：从层次的角度看：物理地址是物理层和数据链路层使用的地址，而IP地址是网络层及其以上使用的地址，是一种逻辑地址（称IP为逻辑地址是因为IP地址是软件实现的）。
> 
> 由于全世界存在着各式各样的网络，它们使用不同的硬件地址。要使这些异构网络能够互相通信就必须进行非常复杂的硬件地址转换工作，因此由用户或用户主机来完成这项工作几乎是不可能的事。但统一的 IP 地址把这个复杂问题解决了。连接到互联网的主机只需拥有统一的 IP 地址，它们之间的通信就像连接在同一个网络上那样简单方便。当需要把 IP地址转换为物理地址时，调用 ARP 的复杂过程都由计算机软件自动进行，而用户是看不见这种调用的过程。因此，在虚拟的IP网络上使用IP地址进行通信给广大的计算机用户带来很大的方便。

**4.8 IP地址方案与我国电话号码体制的主要不同点是什么？**

> 解：最主要的额三个不同点：
> 
> 1. Ip地址是定长对的，因此在互联网上的IP地址总数是一定的。我国的固定电话号码长度是不定长度的。全国的固定号码总容量并没有上限。
> 
> 2. IP地址与所在的地理位置无关。但是固定号码体系中，前面的区号表示的是地理位置，后面号码前三位是电话交换机编号。因此，一个固定电话号=（区号）+（电话交换机编号）+电话机编号。
> 
> 3. 每一个主机的IP地址是全球唯一的。但是电话机可以并联，它们具有相同的号码，几个人可以同时使用这些并联的电话机和对方进行双向通信。

**4.9 试回答下列问题：**

**1. 子网掩码为255.255.255.0代表什么意思？**

> 可以是C类地址对应的子网掩码默认值，也可以是A类或B类地址的掩码，这时主
> 机号由最后8位决定，而路由器寻找网络由前24位决定。

**网络现在的掩码为255.255.255.248，该网络能够连接多少个主机？**

> 248=128+64+32+16+8，用掉了5个网络位，还剩3个主机位，去掉全0和全1的主机好，故还剩6个主机号。

**一个A类网络和一个B类网络的子网号subnet-id分别为16个1和8个1，问这两个网络的子网掩码有何不同？**

> A类地址子网掩码前面由8个1，子网号subnet-id用了16个1，因此掩码由24个1和8个0；
> 
> B类地址子网掩码前面有16个1，子网号subnet-id用了8个1，因此掩码由24个1和8和0。
> 
> 这两个子网掩码一样，但是它们的子网数目并不一样。

**一个 B 类地址的子网掩码是 255.255.240.0，，试问在其中每一个子网上的主机数最多是多少？**

> 240=128+64+32+16，故此子网号subnet-id使用了4位，又因为B类地址默认子网掩码占用16位，故这个网络子网掩码为20个1，剩下12位为主机位，因此每一个子网最多有主机数有2^{12}-2=4096个（不使用全0和全1的主机号）。

**A 类网络的子网掩码为 255.255.0.255，它是否为一个有效的子网掩码？**

> 是一个有效的子网掩码，但是不推荐这样使用，因为子网中的1是不连续的。

**某个IP 地址的十六进制表示是C2.2F.14.81，，试将其转换为点分十进制的形式。这个地址是哪一类IP地址？**

> 十六进制转十进制为：
> 
> C216=12 x 16 + 2 = 192 + 2 = 194
> 2F16=2x16+15=32+15=47
> 1416 =1 x 16 + 4 = 16 + 4 = 20
> 8116=8x16+1=128+1=129
> 
> 因此十进制地址为192.47.20.129，是C类地址。

**C类网络使用子网掩码有无实际意义？为什么？**

> 有实际意义，对于小网络这样做还可以进一步划分几个字网。

**4.10 试辨认以下IP地址的网络类别**

> - 128.36.199.3{B类地址}
> 
> - 21.12.240.17{A类地址}
> 
> - 183.194.76.253{B类地址}
> 
> - 192.12.69.248{C类地址}
> 
> - 89.3.0.1{A类地址}
> 
> - 200.3.6.2{C类地址}

**4.11 IP 数据报中的首部检验和并不检验数据报中的数据。这样做的最大好处是什么？缺点是什么？**

> 解：好处是，不检验数据部分可以加快检验的过程，使转发分组更快。
> 
> 缺点是，数据部分出现差错时不能及早发现。即使是到达了终点，目的主机中的 IP 也仍然不检查数据部分是否正确。当 IP 数据报的数据部分送交上面的运输层时，运输层的 TCP才检查收到的数据有无差错。

**4.12 当某个路由器发现一 IP 数据报的首部检验和有差错时，为什么采取丢弃的办法而不是要求源站重传此数据报？计算首部检验和为什么不采用CRC检验码？**

> 解：IP首部中的源地址也可能变成错误的，要求错误的源地址重传数据报是没有意义的。不使用 CRC 可减少路由器进行检验的时间。

**4.15 什么事最大传输单元MTU，它和IP数据报首部中的哪个字段相关？**

> 解：我们知道，在IP层下面的每一种数据链路层都规定了一个帧所能传送的数据的最大值。这数值称为（IP 层下面的数据链路层所能够传送的）最大传送单元 MTU。当 IP 数据报封装成链路层的帧时，此数据报的总长度（即首部加上数据部分）一定不能超过下面的数据链路层的 MTU 值。
> 
> 显然，MTU 就是 IP 数据报首部中的“总长度字段”的上限值。需要注意的是。这个总
> 长度字段是16位，因此这个字段可以表示的最大数值是216-1，即65535字节。但实际上，下面的数据链路层往往限制了IP数据报的总长度要远远小于这个数值。
> 
> 总之，IP数据报首部中的总长度既不能超过65535字节，也不能超过数据链路层容许的MTU 值。或者用公式表示为：
> 
> IP数据报首部中的总长度<=min{MTU，65535}

**4.16 在互联网中将 IP 数据报分片传送的数据报在最后的目的主机进行组装。还可以有另
种做法，即数据报片通过一个网络就进行一次组装。试比较这两种方法的优劣。**

> 解：在目的站而不是在中间的路由器进行组装是由于
> 
> 1. 路由器处理数据包更简单些；
> 
> 2. 并非所有的数据报片都经过同样的路由器,因此在每一个中间的路由器进行组装可能总会缺少几个数据报片；
> 
> 3. 也许分组后面还要经过一个网络，它还要给这些数据报片划分成更小的片。如果在中间的路由器进行组装就可能会组装多次。

**4.17 一个3200位长的TCP报文传到IP层，加上160位长的首部变成数据报。下面的互联网由两个局域网通过路由器连接起来，但第二个局域网所能传送的最长数据帧的数据部分只有1200位，因此数据报在路由器必须进行分片。试问第二个局域网向其上层要传送多少比特的数据？（这里的数据指的是局域网看见的数据）**

> 解：第二个局域网传送的最大数据帧的数据部分只有1200bit，可见每一个IP数据报最大长度位1200bit，故其IP数据部分（TCP部分）最多为：
> 
> IP数据报的总长度-IP数据报的首部=1200-160=1040bit。
> 
> 而TCP交给IP的数据共为3200bit=1040bit+1040bit+1040bit+80bit。
> 
> 故3200bit长的数据必须划分为4个数据报片，如图T-4-17：
> 
> ![](C:\Users\sheny\AppData\Roaming\marktext\images\2022-01-14-21-34-15-image.png)
> 
> 因此，第二个局域网向上传送1200bitx3+240bit=3840bit。

**4-18 请回答下列问题：**

> - 有人认为：“ARP协议向网络层提供地址转换的服务，因此ARP应当属于数据链路层”，这样的说法为什么是错误的。
>   
>   > 解：不能说“ARP”向网络层提供了服务，因为ARP本事就是网络层的一部分（但IP使用ARP），数据链路层使用硬件地址而不是IP地址，因此ARP并不在数据链路层。
> 
> - 试解释为什么ARP高速缓存每存入一个项目就要设置10~20分钟的超时计时器，这个时间设置的太大或太小会出现什么问题？
>   
>   > 解：当网络层某个IP地址与硬件地址之间的映射关系发生变化时，ARP高速缓冲中的项目就要改变。例如，当更换以太网网卡就会发生这样的情况。10~20分钟更换一张以太网网卡是合理的。超时时间设置的太短会使ARP请求和响应分组的通信量太频繁，而超时时间设置的太长会使更换网卡后的主机迟迟无法和其他的主机上进行网络通信。
> 
> - 至少举例出两种不需要发送ARP请求分组的情况（即不需要请求将某个目的IP地址解析为对应的硬件地址）。
>   
>   > 解： 在源主机ARP高速缓冲中应经拥有了该目的IP地址的项目；源主机发送的是广播分组；源主机与目的主机使用点对点链路。

**4-19 主机A发送IP数据报给主机B，途中经过了5个路由器，试问在IP数据报的发送过程中总共使用了几次ARP？**

> 解：6次。主机发送IP数据报给主机B，每一个路由器在转发IP数据报时各使用一次。

**4-20 设某路由器建立了如下路由表：**

> | 目的网络          | 子网掩码            | 下一跳  |
> | ------------- | --------------- | ---- |
> | 128.96.39.0   | 255.255.255.128 | 接口m0 |
> | 128.96.39.128 | 255.255.255.128 | 接口m1 |
> | 128.96.40.0   | 255.255.255.128 | R2   |
> | 192.4.153.0   | 255.255.255.192 | R3   |
> | *（默认）         | -               | R4   |
> 
> 现共收到5个分组，其目的地址分别为：
> 
> 1. 128.96.39.10
> 
> 2. 128.96.40.12
> 
> 3. 128.96.40.151
> 
> 4. 192.4.153.17
> 
> 5. 192.4.153.90
> 
> 试分别计算下一跳。
> 
> 解：
> 
> > 1. 路由器收到的分组目的地址D1=128.96.39.10，网络N1的子网掩码M1与D1进行与运算，得：128.96.39.0，所得结果与N1匹配，故选接口m0。
> 
> > 2. 路由器收到分组的目的地址D2=128.96.40.12，网络N1的子网掩码M1与D1进行与运算，得：128.96.40.0，结果与N1并不匹配。尝试下一个。
> >    
> >    网络N2的子网掩码M2与D2进行与运算，得：128.96.40.0，与目的网络N2不符，尝试下一个。
> >    
> >    网络N3的子网掩码M3与D2进行与运算，得128.96.40.0，与之匹配，故选择下一跳位R2。
> > 
> > 3. 路由器收到的分组的目的地址D3=128.96.40.151。
> >    
> >    网络N1的子网掩码M1与D3进行与运算：128.96.40.128，所得结果与N1不匹配。
> >    
> >    网络N2的子网掩码M2与D3进行与运算：128.96.40.128，所得结果与N2不匹配。
> >    
> >    网络N3的子网掩码M3与D3进行与运算：128.96.40.128，所得结果与N3也不匹配。
> >    
> >    网络N4的子网掩码M4与D3进行与运算：128.96.40.128，所得结果与N4也不匹配。
> >    
> >    因此选择下一跳为默认路由
> > 
> > 4. 路由器收到的分组的目的地址D4：192.4.153.17。
> >    
> >    网络N1的子网掩码M1与D4进行与运算：192.4.153.0，与N1不匹配。
> >    
> >    网络N2的子网掩码M2与D4进行与运算：192.4.153.0，与N2不匹配。
> >    
> >    网络N3的子网掩码M3与D4进行与运算：192.4.153.0，与N3不匹配。
> >    
> >    网络N4的子网掩码M4与D4进行与运算：192.4.153.0，与N1匹配。
> >    
> >    故下一跳为R3。
> > 
> > 5. 路由器收到的分组的目的地址D5：192.4.153.90。
> >    
> >    网络N1的子网掩码M1与D4进行与运算：192.4.153.0，与N1不匹配。
> >    
> >    网络N2的子网掩码M2与D4进行与运算：192.4.153.0，与N2不匹配。
> >    
> >    网络N3的子网掩码M3与D4进行与运算：192.4.153.0，与N3不匹配。
> >    
> >    网络N4的子网掩码M4与D4进行与运算：192.4.153.64，与N4不匹配。
> >    
> >    故从下一跳选择默认接口R4。

**4-21 某单位分配到一个B类IP地址，其net-id为129.250.0.0，该单位有4000台机器，平均分布在16个不同的地点。如选用子网掩码为255.255.255.0，试给每一个地点分配一个子网号码，并计算出每个地点主机号码的最小值与最大值**

> 4000台主机平均分在16个地方，每个地方250<$2^8$台主机，因此主机号host-id8位就够了，而16个不同的地方就需要16个子网掩码，题目已经给定了子网掩码为255.255.255.0，已经采用了8位子网号，因此可以选用子网号从00000001~00001000，每一个地点的主机号host-id可以从00000001~11111011共250个号码。

**4-22 一个数据报长度为4000字节（固定首部长度），现在经过一个网络传送，但此网络能够传送的最大数长度为1500字节，试问应当划分为几个短些的数据报片？各数据报片的数据字段长度、片偏移字段和MF标志位应该为何值？**

> 解：数据报的总长度-首部长度    ，得到IP数据报的数据部分长度为：
> 
> 4000-20=3980B
> 
> 划分出一个数据报长度（考虑到首部的20字节长）：3980-1500-20=2500B，剩下的长度大于MTU。
> 
> 再划分一个数据报片，2500-1500-20=1020B，剩下的长度小于MTU。
> 
> 因此划分为3个数据报片，其数据字段长度分别为1480字节、1480字节、1020字节。
> 
> MF（more fragment）代表的是标志字段：
> 
> * MF=1表示后面还有分片。
> 
> * MF=0表示后面没有没有切片，该切片为最后一个切片。
> 
> 因此在本题中MF字段值分别为1,1,0
> 
> 片偏移字段的值分别为0，1480/8=185，2x1480/5=370。**片偏移量是8的整数倍**

**4-23 分两种情况（使用子网掩码和CIDR）写出互联网的IP层查找路由的算法**

> 解：
> 
> * 使用子网掩码时，互联网的IP层查找路由的算法如下：
>   
>   1. 从收到的数据报首部提取，目的IP地址D。
>   
>   2. 先判断是否为**直接交付**。对路由直接相连的网络逐个进行排查：用各网络的子网掩码与D进行二进制AND运算，看结构是否为相对应的网络地址匹配。若匹配则把分组进行直接交付（当然还要把D转为硬件地址，把数据报封装成帧发送出去），转发任务结束。否则就是**间接交付**，执行3.
>   
>   3. 若路由表中有目的地址为D的**特定主机路由**，则把数据报传送给路由表中所指明的下一跳路由器；否则执行4。
>   
>   4. 对路由表中的每一行（目的网络地址，子网掩码，下一跳地址），用其中的子网掩码和D进行二进制AND运算其结果为N，若N与目的网络地址匹配，则把数据报传送给该行指明的下一跳路由器；否则执行5.
>   
>   5. 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由，否则执行6.
>   
>   6. 报告转发分组出错。
> 
> * 使用CIDR时，互联网的IP层查找路由的算法和上面的算法并无什么不同。但应该注意的是，在使用CIDR时，我们使用地址掩码（这种地址掩码也常称之为子网掩码）。地址掩码的前一部分是一连串的1，对应于CIDR中的网络前缀。而掩码的后部分是一连串的0，对应于CIDR中的主机部分。在使用CIDR的路由表中，每个项目由“网络前缀”和“下一跳地址”组成。但是在查找路由表时可能会得到不止一个匹配结果。这是应当从匹配结果中选择具有最长网络前缀的路由。如果在路由表中的各项目是按照网络前缀的长度排序的，把最长的网络前缀放在最前面，那么当查找路由表找到匹配的时候，就是找到了正确的路由，因而结束了查找。但如果在路由表中的各项目不是按照网络前缀的长度排序，那么就应当从匹配结果中选择具有最长网络前缀的路由。

**4-24 试找出可产生以下数目的A类子网的掩码地址（采用连续掩码）**

> | 子网掩码数 | 把前两个字节写成二进制 | 去掉全0和全1的子网数       |
> | ----- | ----------- | ----------------- |
> | 2     | 255.192.0.0 | 11111111 11000000 |
> | 6     | 255.224.0.0 | 11111111 11100000 |
> | 30    | 255.248.0.0 | 11111111 11111000 |
> | 62    | 255.252.0.0 | 11111111 11111100 |
> | 122   | 255.254.0.0 | 11111111 11111110 |
> | 250   | 255.255.0.0 | 11111111 11111111 |

**4-26 以下有4个子网掩码，哪些是不推荐使用的？为什么？**

> 1. 176.0.0.0
>    
>    第一个字节的二进制表示：101100000，“1”不连续，不推荐使用。
> 
> 2. 96.0.0.6
>    
>    第一个字节的二进制表示：01100000，“1”的前面有0，不推荐使用。
> 
> 3. 127.192.0.0
>    
>    第一个字节的二进制表示：01111111：“1”的前面有0，不推荐使用。
> 
> 4. 255.128.0.0
>    
>    前面两个字节的二进制表示：11111111 10000000，推荐使用。

**4-26有如下的4个 /24地址块，试进行最大可能的聚合。**

> 212.56.132.0/24
> 
> 212.56.133.0/24
> 
> 212.56.134.0/24
> 
> 212.56.135.0/24
> 
> 解：
> 
> 212.56.132.0/24第三个二进制表示是：**100001**00
> 
> 212.56.133.0/24第三个二进制表示是：**100001**01
> 
> 212.56.134.0/24第三个二进制表示是：**100001**10
> 
> 212.56.135.0/24第三个二进制表示是：**100001**01
> 
> 可以看出，第三个字节仅最后两位是不同的，而前面6位是相同的。因此最大可能的路由聚合的CIDR地址块是**212.56.132.0/22**

**4-27 有两个CIDR地址块208.128/11和208.130.28/22**。是否有哪一个地址块包含了另一个地址块？ 如果有，请指出，并说明理由。

> 解：写出这两个地址块的二进制表示：
> 
> 208.128/11：**11010000 100**00000
> 
> 208.130.28/22：**11010000 10000010 000111**00
> 
> 可见，前一个地址包括后一个地址。

**4-28 已知路由器R1的路由表如下图所示**

> | 地址掩码 | 目的网络地址      | 下一跳地址      | 路由器接口 |
> | ---- | ----------- | ---------- | ----- |
> | /26  | 140.5.12.64 | 180.15.2.5 | m2    |
> | /24  | 130.5.8.0   | 190.16.6.2 | m1    |
> | /16  | 110.71.0.0  | ------     | m0    |
> | /16  | 180.15.0.0  | -----      | m2    |
> | /16  | 190.16.0.0  | -----      | m1    |
> | 默认   | 默认          | 110.71.4.5 | m0    |
> 
> 尝试画出各网络和必要的路由器连接拓扑，标出必要的IP地址和接口。对不确定的情况应当指明。
> 
> 解：如图T-4-28：
> 
> ![](C:\Users\sheny\AppData\Roaming\marktext\images\2022-01-15-17-18-30-image.png)



**4-29 一个自治系统有5个局域网，其连接图如图T-4-29所示。LAN2至LAN5上的主机数分别为：91，150，3，15。该自治系统分配到的IP地址块为30.138.118/23。试给出每一个局域网的地址块（包括前缀）。**

![](C:\Users\sheny\AppData\Roaming\marktext\images\2022-01-16-11-59-51-image.png)

> 解：本题答案不唯一。
> 
> |      | 答案                |
> | ---- | ----------------- |
> | LAN1 | 30.138.119.192/29 |
> | LAN2 | 30.138.119.0/25   |
> | LAN3 | 30.138.118.0/24   |
> | LAN4 | 30.138.119.200/29 |
> | LAN5 | 30.138.119.128/26 |



**4-30 一个大公司有一个总部和三个下属部门，公司分配到的网络前缀是192.77.33/24。公司的网络布局如图T-4-30所示。总部共有5个局域网，其中的LAN1~LAN4都连接到路由器R1上，R1再通过LAN5与路由器R2进行相连。R2和远地的部门的局域网LAN6~LAN8通过广域网进行相连，每一个局域网旁边标明的数字是局域网上的主机数。试给每一个局域网分配一个合适的网络前缀。**

![](C:\Users\sheny\AppData\Roaming\marktext\images\2022-01-16-12-09-54-image.png)

> 解：
> 
> 192.77.33.0/24
> 
> 128 64 32 16    8 4 2 1
> 
> **1100 0000.0000 1101.0010 0001**.0000 0000 
> 
> 50个主机的LAN1需要$2^6$=64>50台主机，故主机号应该为6位，因此需要网络前缀为/26。
> 
> 30台主机的LAN1需要$2^5$=32>30台主机，故主机号应该为5位，因此需要网络前缀为/27。
> 
> 两个10台主机的LAN2和LAN4各需要$2^4$=16>10台主机，故主机号为4位，因此需要网络前缀为/28。
> 
> LAN6~LAN8各需要$2^5$>25>20台主机，故主机号为5位，因此需要网络前缀为/27。
> 
> 本题没有唯一的解，下面给出其中的一种答案：
> 
> | 网段   | 分配的IP地址          | IP地址二进制表示(网络号加粗部分)                          |
> | ---- | ---------------- | ------------------------------------------- |
> | LAN1 | 192.77.33.0/26   | **1100 0000.0000 1101.0010 0001.00**00 0000 |
> | LAN3 | 192.77.33.64/27  | **1101 0000.0000 1101.0010 0001.010**0 0000 |
> | LAN6 | 192.77.33.96/27  | **1101 0000.0000 1101.0010 0001.011**0 0000 |
> | LAN7 | 192.77.33.128/27 | **1101 0000.0000 1101.0010 0001.100**0 0000 |
> | LAN8 | 192.77.33.160/27 | **1101 0000.0000 1101.0010 0001.101**0 0000 |
> | LAN2 | 192.77.33.192/28 | **1101 0000.0000 1101.0010 0001.1100** 0000 |
> | LAN4 | 192.77.33.208/28 | **1101 0000.0000 1101.0010 0001.1101** 0000 |
> | LAN5 | 192.77.33.224/29 | **1101 0000.0000 1101.0010 0001.1110** 0000 |



**4-31 以下地址中的哪一个和86.32/12匹配？请说明理由**

> 1. 86.33.224.123        前4位二进制是：0010
> 
> 2. 86.79.65.216           前4位二进制是：0100
> 
> 3. 86.58.119.74           前4位二进制是：0011
> 
> 4. 86.68.206.154         前4位二进制是：0100
> 
> 32 前4位二进制是：0010
> 
> 因此86.32.224.123和86.32/12匹配



**4-32 以下的地址前缀中哪一个地址与2.52.90.140匹配？请说明理由**

> 1. 0/4
> 
> 2. 32/4
> 
> 3. 4/6
> 
> 4. 80/4
> 
> 给出的前缀有4和6的第一个字节：
> 
> * 2.52.90.140/4=**0000** 0010
> 
> * 2.52.90.140/6=**0000 00**10
> 
> 因此，给出的地址第一个字节的二进制表示如下所示：
> 
> * 0/4：**0000** 0000
> 
> * 32/4：**0010** 0000
> 
> * 4/6：**0000 01**00
> 
> * 80/4：**0101** 0000
> 
> 因此只有0/4和地址2.52.90.140匹配。



**4-33 下面的前缀中哪一个和地址152.7.77.159和152.31.47.252都匹配，请说明理由**

1. 152.40/13

2. 153.40/9

3. 152.64/12

4. 152.0/11

> 解：将两个地址的前两个字节转为二进制表示：
> 
> 1001 1000.0000 1111和1001 1000.00011111
> 
> * 152.40/13前两个字节转为二进制：**10011000.00101**000，与这两个地址不匹配。
> 
> * 153.40/9前两个字节转为二进制：**1001 1001.0**010 1000，与这两个地址不匹配。
> 
> * 152.64/12前两个字节转为二进制：**1001 1000.0100** 0000，与这两个地址不匹配。
> 
> * 152.0/11前两个字节转为二进制:**1001 1000.000**0 0000，与这两个地址匹配。



**4-34 与下列掩码相对应的网络前缀各有多少位？**

1. 192.0.0.0

2. 240.0.0.0

3. 255.224.0.0

4. 255.255.255.252

> 解：
> 
> * 192.0.0.0：1100 0000.0000 0000.0000 0000.0000 0000 网络前缀2位。
> 
> * 240.0.0.0：1111 0000.0000 0000.0000 0000.0000 0000 网络前缀4位。
> 
> * 255.224.0.0：1111 1111.1110 0000.0000 0000.0000 0000 网络前缀11位。
> 
> * 255.255.255.252:1111 1111.1111 1111.1111 1111.1111 1100 网络前缀30位。



**4-35 已知地址块中的一个地址是140.120.84.24/20**。试求这个地址块中的最小地址和最大地址，子网掩码是什么？地址块中共有多少个地址？相当于多少个C类地址？

> 解：该地址是一个B类地址，网络前缀为20，将第三个字节转为二进制：
> 
> —.—.0101 0000.—
> 
> 最小地址：前20位为网络号，后面全为0：—.—.0101 0000.0000 0000，即：
> 
> 140.120.80.0/20
> 
> 最大地址：前20位为网络号，后面全为1：—.—.0101 0000.1111 1111，即：
> 
> 140.120.80.255/20
> 
> 地址块中共有$2^{32-20}=4096个地址。
> 
> C类地址共有$2^{32-24}$=256个地址。故相当于C类地址$4096/256$=16个C类地址。



**4-36 已知地址块中的一个地址是190.87.140.202/29。试重新计算上题**

> 解：该地址是一个B类地址，网络前缀为29，将IP地址第四字节转为二进制：
> 
> —.—.—.**1100 10**10
> 
> 最小地址：—.—.—.1101 1000：190.87.140.200/29。
> 
> 最大地址：—.—.—.1101 1011：190.87.140.207/29。
> 
> 地址数为$2^{32-29}=8$个。
> 
> 相当于$8/256=1/32$个C类地址。



**4-37 某单位分配到一个地址块136.23.12.64/26。现在需要进一步划分为4个一样大小的子网，试问：**

1. 每一个子网的网络前缀有多长？

2. 每一个子网中有多少个地址？

3. 每一个子网的地址块是什么？

4. 每一个子网可分配给主机使用最小的地址和最大的地址是什么？

> 解：
> 
> 1. 原来的网络前缀为26位，需要划分为4个子网，因此借主机2位充当网络位，因此每一个子网前缀有28位。
> 
> 2. 每个子网有32-28=4个主机位，因此，每个字网有$2^4-2=14$个地址。
> 
> 3. 四个子网的地址块如下所示：
>    
>    * 136.23.12.64/28        64：**0100** 0000
>    
>    * 136.23.12.80/28        80：**0101** 0000
>    
>    * 136.23.12.96/28        96：**0110** 0000
>    
>    * 136.23.12.112/28     112：**0111** 0000
> 
> 4. 地址块136.23.12.64/28可以分配给主机使用（将第四个字节转为二进制）：
>    
>    * 最小地址：0100 0001：136.23.12.65/28
>    
>    * 最大地址：0100 1110：136.23.12.78/28
>    
>    地址块136.23.12.80/28可以分配给主机使用（将第四个字节转为二进制）：
>    
>    * 最小地址：0101 0001：136.23.12.81/28
>    
>    * 最大地址：0101 1110：136.23.12.94/28
>    
>    地址块136.23.12.96/28可以分配给主机使用（将第四个字节转为二进制）：
>    
>    * 最小地址：0110 0001：136.23.12.97/28
>    
>    * 最大地址：0110 1110：136.23.12.110/28
>    
>    地址块136.23.12.112/28可以分配给主机使用（将第四个字节转为二进制）：
>    
>    * 最小地址：0111 0001：136.23.12.113/28
>    
>    * 最大地址：0111 1110：136.23.12.126/28



**4-38 IGP和EGP这两类协议的主要区别是什么？**

> 解：
> 
> * IGP是内部网关协议，即在一个自治系统内部使用的路由选择协议，这与其他自治系统内部使用的路由选择协议无关。目前这类协议使用最多的是RIP和OSPF协议、
> 
> * EGP是外部网关协议。若源主机和目的主机处于不同的自治系统中（这两个自治紫铜可能使用的不是一样的内部网关协议），当数据传到一个自治系统边界的时候，就需要使用一种协议将路由选择信息传递到另一个自治系统中。这样的协议就是外部网关协议EGP。当前外部网关协议是BGP第四个版本，即BGP-4。



**4-39 试简述RIP、OSPF、和BGP；路由选择协议的主要特点**

> 解：
> 
> * RIP是一种分布式的基于距离向量的路由选择协议，是互联网的标准协议，其最大优点就是简单。RIP协议的主要特点是：
>   
>   1. 仅和相邻路由器交换信息。如果两个路由器之间的通信不经过另一个路由器，那么这两个路由器就是相邻的。RIP协议规定，不相邻的路由器不交换信息。
>   
>   2. 路由器交换的信息是当前本路由器所知道的全部信息，即自己的路由表。也就是说，交换的信息是：“我到本自治系统所有网络的最短距离，以及到每一个网络的下一跳地址。”
>   
>   3. 按固定的时间间隔交换信息，例如30s，然后路由器根据收到的路由信息交换路由表，当网络拓扑发生变化的时候，路由器也及时向相邻路由器通知拓扑变化后的路由信息。
> 
> * OSPF最主要的特征就是使用分布式的链路状态协议。OSPF协议的特点是：
>   
>   1. 向本自治系统中所有路由器发送信息。这里使用的方法是洪泛法，这就是路由器通过所有输出端口向所有相邻的路由器发送信息。而每一个相邻路由器又将此信息发往其所有的相邻路由器（但不再发送给刚刚发来信息的路由器）。这样，最终整个区域中所有的路由器都得到了这个信息的副本。
>   
>   2. 发送的信息就是与本路由器相邻的所有路由器的链路状态，但这只是路由器知道的部分信息。所谓“链路状态”就是说明本路由器都和哪些路由器相邻，以及该链路的“度量”。OSPF将这个“度量”用来表示费用、距离、时延、带宽等等。这些都由网络管理人员来决定。因此比较灵活。有时为了方便称度量为“代价”。
>   
>   3. 只有当链路状态发生变化时，路由器才会向所有路由器用洪泛法发送此信息。
> 
> * BGP是不同自治系统的路由器之间交换路由信息的协议，它采用路径向量路由选择协议，BGP协议的主要特点是：
>   
>   1. BGP在自治系统间交换“可达性”信息（即可达或不可达）。例如告诉相邻路由器;"到达，目的网络N可经过ASx"。
>   
>   2. 自治系统之间你的路由器必须考虑有关策略。
>   
>   3. BGP只能是力求寻找一条能够到达目的网络且**比较好**的路由（不能兜圈子），而并非要找一条最佳路由。






































